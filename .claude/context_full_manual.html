<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SAM – Project Context (HTML)</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.5; padding: 24px; color: #111; }
  h1, h2, h3, h4 { margin-top: 1.6em; }
  code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow-x: auto; }
  .marker { padding: 8px 12px; background: #fff9c4; border: 1px solid #f0e68c; border-radius: 6px; display: inline-block; }
  ul { margin-left: 1.2em; }
</style>
</head>
<body>
<p class="marker">THIS IS THE ANCHOR-FREE VERSION (for verification)</p>

<h1>SAM – Project Context</h1>
<p><em>Last updated: 2026-02-07</em></p>
<p>See also: Changelog and Consolidated Engineering History (refer to repository files).</p>

<h2>1) Purpose &amp; Principles</h2>
<ul>
  <li>Native macOS SwiftUI application for independent financial strategists. Observes interactions (Calendar, Contacts), creates Evidence, and generates AI-backed Insights for relationship management.</li>
  <li>AI assists but never acts autonomously. User reviews and approves everything.</li>
  <li>Design values: Clarity, Responsiveness, Familiarity, Trust. Prefer standard macOS patterns.</li>
</ul>

<h2>2) System Architecture (At-a-Glance)</h2>
<ul>
  <li>Navigation: NavigationSplitView with sidebar (Awareness, People, Contexts, Inbox). Sidebar selection via @AppStorage.</li>
  <li>Data Models (@Model): SamEvidenceItem, SamPerson, SamContext, SamInsight, SamNote, SamAnalysisArtifact.</li>
  <li>Repositories/Coordinators: EvidenceRepository, PeopleRepository, CalendarImportCoordinator, ContactsImportCoordinator.</li>
  <li>Singletons: EvidenceRepository.shared, PeopleRepository.shared, CalendarImportCoordinator.eventStore, ContactsImportCoordinator.contactStore, SAMModelContainer.shared (nonisolated), PermissionsManager.shared.</li>
  <li>Views (primary): InboxListView/InboxDetailView/AwarenessHost, PeopleListView/PersonDetailHost, ContextListView/ContextDetailRouter.</li>
  <li>Concurrency: Swift 6 async/await; SAMModelContainer.shared and newContext() are nonisolated for background usage.</li>
</ul>

<h3>Architecture (Details)</h3>
<ul>
  <li>Navigation: NavigationSplitView with sidebar (Awareness, People, Contexts, Inbox). Sidebar selection via @AppStorage.</li>
  <li>Data layer:
    <ul>
      <li>@Model classes: SamEvidenceItem (Evidence), SamPerson (People), SamContext (Contexts)</li>
      <li>Repositories: EvidenceRepository (Evidence), PeopleRepository (People)</li>
      <li>Views: InboxListView, InboxDetailView, AwarenessHost (Evidence); PeopleListView, PersonDetailHost (People); ContextListView, ContextDetailRouter (Contexts)</li>
    </ul>
  </li>
  <li>Key singletons: EvidenceRepository.shared / PeopleRepository.shared; CalendarImportCoordinator.eventStore / ContactsImportCoordinator.contactStore; SAMModelContainer.shared (nonisolated); PermissionsManager.shared</li>
</ul>

<h2>3) Critical Gotchas (Must Follow)</h2>

<h3>3.1 Permissions (CNContactStore / EKEventStore)</h3>
<ul>
  <li>Any data access on CNContactStore/EKEventStore triggers a system dialog if not authorized.</li>
  <li>Safe (no dialog):</li>
</ul>
<pre><code>CNContactStore.authorizationStatus(for: .contacts)
EKEventStore.authorizationStatus(for: .event)
</code></pre>

<p>Unsafe calls (trigger permission dialog if not authorized):</p>
<pre><code>store.unifiedContact(withIdentifier:keysToFetch:)
store.unifiedContacts(matching:keysToFetch:)
store.enumerateContacts(with:)
store.groups(matching:)
store.execute(saveRequest)
eventStore.calendars(for:)
eventStore.events(matching:)
</code></pre>

<p>The Rule:</p>
<pre><code>// Always check authorization BEFORE any data access
guard CNContactStore.authorizationStatus(for: .contacts) == .authorized else {
    return nil  // or return false, or return []
}

// Now safe to access data
let contact = try store.unifiedContact(...)
</code></pre>

<p>Best Practices:</p>
<ol>
  <li>Use a single shared store instance (singleton pattern) throughout the app</li>
  <li>Check authorization status before every data access operation</li>
  <li>Keep all permission requests in Settings → Permissions tab for user context</li>
  <li>Never create new CNContactStore() or EKEventStore() instances in views or helpers</li>
  <li>Pass the shared store as a parameter to utility functions</li>
</ol>

<p>Affected Files:</p>
<ul>
  <li>ContactValidator.swift - Must guard all validation methods</li>
  <li>PersonDetailView.swift - Must use shared store for photo fetching</li>
  <li>ContactsImportCoordinator.swift - Owns the shared CNContactStore</li>
  <li>PermissionsManager.swift - Owns the authorization flow</li>
</ul>

<h3>Store &amp; Singleton Management</h3>
<ul>
  <li>EKEventStore, CNContactStore, EvidenceRepository, PeopleRepository are singletons. On macOS, per-instance auth cache means a second EKEventStore will see stale .notDetermined forever. Never create duplicates.</li>
  <li>Repositories fallback to full schema (SAMSchema.allModels with "SAM_v2" config) if not configured. This prevents schema-mismatch crashes during early initialization.</li>
</ul>

<h3>SwiftData Enum Storage</h3>
<p>Never store enums directly in @Model classes. SwiftData schema validation fails with "rawValue is not a member" errors. Pattern: Store raw value + @Transient computed property:</p>
<pre><code>var stateRawValue: String
@Transient var state: EvidenceTriageState {
  get { EvidenceTriageState(rawValue: stateRawValue) ?? .needsReview }
  set { stateRawValue = newValue.rawValue }
}
</code></pre>
<p>Predicates:</p>
<pre><code>#Predicate { $0.stateRawValue == "needsReview" }
let target = "needsReview"; #Predicate { $0.stateRawValue == target }
</code></pre>

<h3>SwiftData Relationships</h3>
<ul>
  <li>Inverse relationships cannot be optional: var supportingInsights: [SamInsight] = [] (not [SamInsight]?)</li>
  <li>Delete order: Evidence → Contexts → People (reverse of insert to avoid cascade issues)</li>
</ul>

<h3>SwiftUI &amp; Predicates</h3>
<ul>
  <li>InboxDetailLoader uses unfiltered @Query + .first { $0.id == id }. Dynamic #Predicate in custom init crashes Swift 6.2 compiler.</li>
  <li>.searchable on HSplitView/NavigationStack, not on List (causes phantom padding flicker on macOS)</li>
</ul>

<h3>Throttling &amp; Timing</h3>
<ul>
  <li>Periodic triggers (app launch/activate) = 5min interval</li>
  <li>Event-driven triggers (calendar/contacts changed, permission granted) = 10sec interval</li>
  <li>PopoverAnchorView sets binding in updateNSView (not makeNSView) to avoid layout recursion</li>
</ul>

<h3>Permissions &amp; Auth</h3>
<ul>
  <li>All permission prompts originate from Settings only</li>
  <li>ContactValidator must not check authorizationStatus before operations—attempt directly and catch errors</li>
</ul>

<h3>Backup &amp; Crypto</h3>
<ul>
  <li>kCCPRFHmacAlgoSHA256 not bridged on macOS; named constant + precondition guards value changes</li>
  <li>Restore deletes in reverse-dependency order</li>
  <li>bulkUpsertFromContacts is best-effort (logs per-item errors but commits successes)</li>
</ul>

<h2>4) Current Capabilities (High Signal)</h2>

<h3>Calendar &amp; Contacts Integration</h3>
<ul>
  <li>User selects/creates a "SAM" calendar; imports events with throttled updates</li>
  <li>Contacts group-based import via PeopleRepository</li>
  <li>Single shared EKEventStore and CNContactStore (per-instance auth cache on macOS)</li>
  <li>Pruning: removes Evidence when events deleted or moved out of SAM calendar</li>
  <li>Contact validation &amp; sync with auto-clear of stale contactIdentifier values</li>
</ul>

<h3>Evidence, Signals &amp; Insights</h3>
<ul>
  <li>Calendar events → Evidence with deterministic signals</li>
  <li>InsightGenerator creates persisted SamInsight from signals</li>
  <li>Evidence relationships: SamInsight.basedOnEvidence ↔ SamEvidenceItem.supportingInsights</li>
  <li>Automatic generation after imports (debounced)</li>
</ul>

<h3>Inbox</h3>
<ul>
  <li>Shows Evidence needing review; link to People/Contexts; accept/decline proposed links</li>
  <li>Fully migrated to SwiftData (@Query on SamEvidenceItem)</li>
  <li>Participant resolution via background CNContactStore lookup</li>
</ul>

<h3>People &amp; Contexts</h3>
<ul>
  <li>Create/manage People and Contexts (Household, Business, Recruiting)</li>
  <li>Duplicate detection; person merge via LinkContactSheet</li>
  <li>Fully migrated to SwiftData (@Query on SamPerson and SamContext)</li>
  <li>Contact linking with photo fetch; unlinked badge flow</li>
</ul>

<h3>Awareness</h3>
<ul>
  <li>Groups signals into categories: Needs Attention, Follow-Ups, Opportunities</li>
</ul>

<h3>Backup &amp; Restore</h3>
<ul>
  <li>AES-256-GCM + PBKDF2 encrypted backups with versioned DTOs</li>
  <li>Restore re-links relationships by UUID</li>
</ul>

<h3>Settings</h3>
<ul>
  <li>Calendar/Contacts permissions and configuration</li>
  <li>All system permission prompts originate from Settings only</li>
</ul>

<h3>Developer Tools</h3>
<ul>
  <li>DEBUG-only fixture seeding (FixtureSeeder with stable UUIDs)</li>
  <li>Development tab in Settings:
    <ul>
      <li>Export developer logs as text file</li>
      <li>Clear logs button</li>
      <li>Restore developer fixture (DEBUG-only)</li>
      <li>Deduplicate insights utility</li>
    </ul>
  </li>
</ul>

<h2>5) Recent Fixes (Why They Matter)</h2>

<h3>Permission Dialog UX Fix — COMPLETE (Feb 7, 2026)</h3>
<p><strong>Problem:</strong></p>
<ul>
  <li>Contacts permission dialog appeared unexpectedly at app startup</li>
  <li>Users saw permission requests without context before reaching Settings</li>
  <li>Intermediate confirmation dialogs created unnecessary friction</li>
</ul>
<p><strong>Root Causes:</strong></p>
<ul>
  <li>ContactValidator.isValid() called store.unifiedContact() without checking authorization first</li>
  <li>PersonDetailView created new CNContactStore() instances instead of using shared singleton</li>
  <li>Permission request flow had redundant confirmation alert before system dialog</li>
</ul>
<p><strong>Solutions Applied:</strong></p>
<ul>
  <li>Added authorization guards to ContactValidator.isValid() and isInSAMGroup()</li>
  <li>Changed to shared store - ContactPhotoFetcher now uses ContactsImportCoordinator.contactStore</li>
  <li>Removed intermediate alerts - Buttons now go directly to system permission dialogs</li>
  <li>Centralized permission flow - All requests route through Settings → Permissions tab</li>
</ul>
<p><strong>Files Changed:</strong></p>
<ul>
  <li>ContactValidator.swift - Added CNContactStore.authorizationStatus guards before all data access</li>
  <li>PersonDetailView.swift - Switched to shared store singleton</li>
  <li>SamSettingsView.swift - Removed redundant confirmation alerts, streamlined button flow</li>
</ul>
<p><strong>Result:</strong> Clean permission flow with no surprise dialogs. Users only see permission requests when they explicitly click buttons in Settings.</p>

<hr />

<h3>Freeform Notes as Evidence — Notes-first COMPLETE (Feb 7, 2026)</h3>
<p><strong>Fully Working Features:</strong></p>
<ul>
  <li>Note Creation: "Add Note" button in Inbox toolbar and Person detail page
    <ul>
      <li>Sheet UI with person selection (pre-selects context person automatically)</li>
      <li>Note saves with linked people relationships</li>
    </ul>
  </li>
  <li>Entity Extraction (Heuristic): NoteLLMAnalyzer extracts from note text:
    <ul>
      <li>People: Detects names with relationships (e.g., "William (child)" from "I just had a son. His name is William")</li>
      <li>Financial Topics: Detects life insurance, retirement, annuities, 401k/IRA mentions with amounts</li>
      <li>Facts: Follow-up requests, action items</li>
      <li>Implications: Opportunities, risks, concerns</li>
      <li>Affect: Positive/neutral/negative sentiment</li>
    </ul>
  </li>
  <li>Evidence Pipeline: Complete flow working:
    <ul>
      <li>SamNote (SwiftData) → SamAnalysisArtifact → SamEvidenceItem → signals → SamInsight</li>
      <li>Notes appear in Inbox with state=needsReview</li>
      <li>Evidence items linked to selected people via bidirectional @Relationship</li>
    </ul>
  </li>
  <li>Insight Generation:
    <ul>
      <li>Signals generated from extracted facts/implications</li>
      <li>Insights created with detailed messages including topics (e.g., "Possible opportunity regarding life insurance, retirement (Harvey Snodgrass)")</li>
      <li>Insights properly linked to people and appear on their detail pages</li>
    </ul>
  </li>
  <li>Schema &amp; Relationships:
    <ul>
      <li>Added SamNote and SamAnalysisArtifact to schema (SAM_v5 database)</li>
      <li>Fixed bidirectional inverse relationships: SamPerson.insights ↔ SamInsight.samPerson</li>
      <li>Made 20+ models/enums public for factory pattern access control</li>
    </ul>
  </li>
  <li>Developer Tools:
    <ul>
      <li>"Restore developer fixture" button now properly deletes all data in dependency order</li>
      <li>Comprehensive debug logging throughout entire pipeline</li>
    </ul>
  </li>
</ul>
<p><strong>Current Limitations (Enhancement Opportunities):</strong></p>
<ul>
  <li>Foundation Models disabled: Currently using heuristic extraction only (TODO to re-enable guided generation when API surface confirmed)</li>
  <li>Extracted people not actionable: William (child) detected but not offered as new contact suggestion</li>
  <li>Note text not visible in UI: Note content only in Inbox detail (snippet), full text requires clicking into evidence item</li>
  <li>Analysis artifacts hidden: Extracted people/topics/facts not displayed in UI for user verification</li>
</ul>

<h2>6) Roadmap (Next Steps)</h2>

<h3>Phase 5: Communication Integration</h3>
<p><strong>Next Enhancements (Optional):</strong></p>
<ul>
  <li>[ ] Display extracted entities in Inbox detail view:
    <ul>
      <li>Show artifact.people with "Create Contact" action for each</li>
      <li>Show artifact.topics as tags/chips</li>
      <li>Show artifact.facts and artifact.implications as expandable sections</li>
    </ul>
  </li>
  <li>[ ] Add notes to "Recent Interactions" on Person detail page</li>
  <li>[ ] Re-enable Foundation Models guided generation when API available:
    <ul>
      <li>Uncomment #if canImport(FoundationModels) block in NoteLLMAnalyzer</li>
      <li>Replace heuristic with LLM-powered extraction for better accuracy</li>
    </ul>
  </li>
  <li>[ ] Improve heuristic extraction patterns:
    <ul>
      <li>Better regex for name detection (handle multi-word names, titles)</li>
      <li>Detect more financial products (college savings, disability, etc.)</li>
      <li>Extract dollar amounts more reliably</li>
    </ul>
  </li>
  <li>[ ] Create "Suggested Contacts" section in Inbox or Awareness showing extracted people with quick-add actions</li>
</ul>

<ol>
  <li>Mail Integration
    <ul>
      <li>Observe Mail.app for interaction history per contact</li>
      <li>Surface recent email threads in person detail view</li>
      <li>"Draft Email" action that opens Mail.app with pre-filled recipient</li>
      <li>Parse email metadata into Evidence items</li>
    </ul>
  </li>
  <li>Calendar Deep Integration
    <ul>
      <li>Two-way sync: Create calendar events from SAM</li>
      <li>"Schedule Meeting" action opens Calendar.app with attendees pre-filled</li>
      <li>Show upcoming meetings in person/context detail view</li>
      <li>Meeting prep assistant (surfaces relevant insights before meetings)</li>
    </ul>
  </li>
  <li>Contacts Enrichment
    <ul>
      <li>Write SAM metadata back to Contacts notes field (optional, user-controlled)</li>
      <li>"Open in Contacts" quick action</li>
      <li>Photo sync improvements</li>
      <li>Birthday/anniversary reminders</li>
    </ul>
  </li>
</ol>

<h3>Phase 6: AI Assistant (Cognitive Layer)</h3>
<p><strong>Goal:</strong> Introduce assistive AI that feels like a thoughtful junior partner</p>
<ol>
  <li>Interaction Analysis
    <ul>
      <li>Analyze meeting transcripts (Zoom integration placeholder)</li>
      <li>Extract action items and commitments</li>
      <li>Detect sentiment and relationship health signals</li>
      <li>Generate meeting summaries</li>
    </ul>
  </li>
  <li>Proactive Recommendations
    <ul>
      <li>"You haven't connected with [Person] in 45 days" nudges</li>
      <li>Suggest follow-up actions based on evidence patterns</li>
      <li>Highlight time-sensitive opportunities</li>
      <li>Best practice coaching (WFG compliance-aware)</li>
    </ul>
  </li>
  <li>Communication Drafting
    <ul>
      <li>Draft follow-up emails based on meeting context</li>
      <li>Suggest talking points for upcoming meetings</li>
      <li>Template library for common interactions</li>
      <li>Always require explicit user approval before sending</li>
    </ul>
  </li>
  <li>Natural Language Interface
    <ul>
      <li>Quick add: "Remind me to follow up with John next Tuesday"</li>
      <li>Search by intent: "Show me everyone I need to call this week"</li>
      <li>Summarization: "What happened with the Smith household last quarter?"</li>
    </ul>
  </li>
</ol>

<h3>Phase 7: Compliance &amp; Data Integrity</h3>
<p><strong>Goal:</strong> Build trust through transparency and safety mechanisms</p>
<ol>
  <li>Change History &amp; Undo
    <ul>
      <li>Implement 30-day change history for relationships and metadata</li>
      <li>Visual timeline of changes per person/context</li>
      <li>Multi-level undo/redo (persistent across sessions)</li>
      <li>Export change log for compliance audits</li>
    </ul>
  </li>
  <li>Data Export &amp; Portability
    <ul>
      <li>CSV/JSON export for people, contexts, and interactions</li>
      <li>Integration with WFG reporting systems</li>
      <li>"Share Person" creates shareable summary PDF</li>
    </ul>
  </li>
  <li>Privacy Controls
    <ul>
      <li>Granular permission management (which calendars/contact groups to observe)</li>
      <li>Data retention policies (configurable auto-delete old evidence)</li>
      <li>Audit log of AI recommendations and user actions</li>
    </ul>
  </li>
</ol>

<h3>Phase 8: iOS Companion App</h3>
<p><strong>Goal:</strong> Lightweight mobile experience for on-the-go relationship management</p>
<ol>
  <li>Core Views
    <ul>
      <li>Today view: Upcoming meetings + follow-up reminders</li>
      <li>Quick person lookup</li>
      <li>Evidence review and triage (swipe to accept/dismiss)</li>
      <li>Awareness dashboard</li>
    </ul>
  </li>
  <li>Mobile-Specific Features
    <ul>
      <li>Call integration (tap to call from person detail)</li>
      <li>Location-based reminders ("Call Sarah when you arrive at office")</li>
      <li>Voice notes as evidence items</li>
      <li>Share extension (capture emails/messages as evidence)</li>
    </ul>
  </li>
  <li>Sync Strategy
    <ul>
      <li>CloudKit sync between macOS and iOS</li>
      <li>Conflict resolution for offline edits</li>
      <li>Local-first architecture with opportunistic sync</li>
    </ul>
  </li>
</ol>

<h2>7) UX Guardrails (Stay Native)</h2>
<p>Align with native macOS patterns and Apple HIG expectations. Phase 4 refinements include search/filter chips, organized toolbars, and comprehensive keyboard shortcuts.</p>

<h2>8) Technical Debt &amp; Polish</h2>
<ol>
  <li>Remaining Concurrency Warnings (deferred)
    <ul>
      <li>Address DevLogStore.shared ambiguity and actor isolation issues</li>
      <li>Full Swift 6 strict concurrency compliance</li>
      <li>Note: Functional as-is; low priority</li>
    </ul>
  </li>
  <li>Performance Optimization
    <ul>
      <li>Profile and optimize SwiftData queries for large datasets (1000+ people)</li>
      <li>Background indexing for search</li>
      <li>Lazy loading for detail views</li>
    </ul>
  </li>
  <li>Accessibility Audit
    <ul>
      <li>Full VoiceOver support</li>
      <li>Dynamic Type at all text scales</li>
      <li>Keyboard-only navigation testing</li>
      <li>Reduced Motion respect</li>
    </ul>
  </li>
  <li>Design System
    <ul>
      <li>Consistent spacing, typography, and color tokens</li>
      <li>Reusable component library</li>
      <li>Light/Dark mode refinement</li>
      <li>SF Symbols usage audit</li>
    </ul>
  </li>
</ol>

<h2>9) Non-Negotiables</h2>
<ul>
  <li>AI suggestions require explicit user approval; no autonomous actions.</li>
  <li>All permission prompts originate from Settings; never surprise the user.</li>
  <li>Maintain data integrity and user trust above feature velocity.</li>
</ul>

</body>
</html>
